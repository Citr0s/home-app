name: CI Build

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

env:
    CHROME_BIN: /usr/bin/chromium-browser

jobs:

    setup:
        runs-on: self-hosted
        steps:
            -   uses: actions/checkout@v3

            -   uses: actions/setup-node@v3
                with:
                    node-version: '20'
                    cache: 'yarn'

            -   name: Installing Yarn packages
                run: yarn


    build-fe:
        needs: setup
        runs-on: self-hosted
        steps:
            -   uses: actions/checkout@v3

            -   name: Installing Yarn packages
                run: yarn --prefer-offline

            -   name: Compiling FE
                run: npm run build

            -   name: Debug
                run: ls -lsa

            #-   uses: actions/upload-artifact@v3
            #    with:
            #        name: dist-fe
            #        path: dist/home-box-landing

    build-be:
        runs-on: self-hosted
        steps:
            -   uses: actions/checkout@v3

            -   uses: actions/setup-dotnet@v3
                with:
                    dotnet-version: '7.0.x'

            -   name: Testing BE
                run: dotnet build api/home-box-landing/HomeBoxLanding.sln

    #test-fe:
    #    needs: build-fe
    #    runs-on: self-hosted

    #    steps:
    #        -   uses: actions/checkout@v3

    #        -   name: Installing Yarn packages
    #            run: yarn --prefer-offline

    #        -   name: Testing FE
    #            run: npm run test-ci

    test-be:
        needs: build-be
        runs-on: self-hosted

        steps:
            -   uses: actions/checkout@v3

            -   uses: actions/setup-dotnet@v3
                with:
                    dotnet-version: '7.0.x'

            -   name: Testing BE
                run: dotnet test api/home-box-landing/HomeBoxLanding.sln

    lint-fe:
        needs: build-fe
        runs-on: self-hosted
        steps:
            -   uses: actions/checkout@v3

            -   name: Installing Yarn packages
                run: yarn --prefer-offline

            -   name: Linting FE
                run: npm run lint

    docker-build-test:
        needs: lint-fe
        runs-on: self-hosted
        steps:
            -   uses: actions/checkout@v3

            -   name: Installing Yarn packages
                run: yarn --prefer-offline

            -   name: Compiling FE
                run: npm run build

            -   name: Build the Docker image
                run: docker build . --file Dockerfile

    #deploy-files:
    #    needs: docker-build-test
    #    runs-on: self-hosted
    #    steps:
    #        -   uses: actions/download-artifact@v3
    #            with:
    #                name: dist-fe
    #                path: dist/home-box-landing
    #
    #        -   uses: garygrossgarten/github-action-scp@release
    #            with:
    #                local: /home/${{ secrets.SSH_USER }}/actions-runner/_work/home-box-landing/home-box-landing/dist/home-box-landing
    #                remote: /home/${{ secrets.SSH_USER }}/tools/docker/home-box-landing/dist/home-box-landing
    #                host: ${{ secrets.HOST }}
    #                username: ${{ secrets.SSH_USER }}
    #                password: ${{ secrets.PASSWORD }}
